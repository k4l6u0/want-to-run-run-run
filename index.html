<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¦å‹•ä¸€å‹•å—?</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #333;
            --text-sub: #555;
            
            --level-rest: #ef9a9a;       /* Sleep */
            --level-bad: #ffcc80;        /* Light Rain */
            --level-ok: #fff9c4;         /* Nice */
            --level-good: #b3e5fc;       /* Comfy */
            --level-excellent: #c8e6c9;  /* Great */
        }

        body {
            font-family: "Segoe UI Emoji", "Microsoft JhengHei", sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            min-height: 100vh;
        }

        header {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .app-name { font-size: 1.4rem; font-weight: 900; letter-spacing: 1px; font-style: italic; }
        .btn-reload {
            background: white; color: #1e3c72; border: none; padding: 8px 15px;
            border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .build-info { font-family: monospace; opacity: 0.7; font-size: 0.7rem; color: #eee; }

        .container {
            max-width: 900px; margin: 20px auto; padding: 0 10px;
            display: flex; flex-direction: column; gap: 15px; 
        }

        .location-row {
            display: flex; background: var(--card-bg); border-radius: 16px;
            overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.25); min-height: 220px;
        }

        /* Left Header */
        .loc-header {
            background: #2c3e50; color: white; width: 50px;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; padding: 10px 5px; flex-shrink: 0;
        }
        .loc-title { writing-mode: vertical-lr; font-size: 1.2rem; font-weight: bold; letter-spacing: 3px; text-orientation: upright; }
        .loc-sub { writing-mode: vertical-lr; font-size: 0.8rem; opacity: 0.8; margin-top: 10px; text-orientation: upright; }

        /* Right Content */
        .loc-content {
            flex: 1; padding: 0;
            display: flex; flex-direction: column;
            min-width: 0; position: relative;
        }
        
        .loc-main-data { padding: 15px 20px 10px 20px; }

        .update-tag { 
            position: absolute; top: 10px; right: 10px; 
            font-size: 0.75rem; color: #888; 
            background: rgba(255,255,255,0.8); 
            padding: 2px 6px; border-radius: 4px; 
        }

        /* Info Top */
        .info-top { display: flex; justify-content: space-between; align-items: stretch; margin-bottom: 15px; gap: 15px; }
        
        .weather-big { display: flex; flex-direction: column; justify-content: center; min-width: 120px;}
        .weather-temp { font-size: 3.5rem; font-weight: 800; line-height: 1; color: #2c3e50; }
        .weather-desc { font-size: 1.1rem; font-weight: bold; color: #666; margin-top: 5px; }

        /* Rec Box */
        .rec-box {
            background: #f0f4f8; padding: 12px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: stretch;
            flex: 1; gap: 5px;
        }
        .rec-item { 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; text-align: center;
            flex: 1; border-right: 1px solid #ddd;
        }
        .rec-item:last-child { border-right: none; }
        
        .rec-emoji { font-size: 1.8rem; line-height: 1.2; margin-bottom: 2px; }
        .rec-text { font-size: 0.85rem; font-weight: bold; color: #444; line-height: 1.2;}

        /* --- Timeline --- */
        .timeline-container { margin-bottom: 10px; }
        .timeline-header { font-size: 0.85rem; color: #888; margin-bottom: 5px; display: flex; justify-content: space-between; padding: 0 2px; }

        .traffic-lights {
            display: flex; height: 150px; border-radius: 12px;
            overflow-x: auto; overflow-y: hidden; background: #fff;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05); scroll-snap-type: x mandatory;
            border: 1px solid #eee;
        }

        .light-block {
            flex: 0 0 22%; min-width: 85px;
            display: flex; flex-direction: column; justify-content: space-evenly;
            align-items: center; text-align: center;
            border-right: 1px solid rgba(255,255,255,0.6);
            padding: 8px 2px; scroll-snap-align: start; position: relative;
        }
        .light-block:last-child { border-right: none; }

        .time-label { font-size: 0.8rem; font-weight: bold; color: #444; white-space: nowrap;}
        .status-emoji { font-size: 2rem; line-height: 1; }
        .status-text { font-size: 0.9rem; font-weight: 900; color: #222; }
        .temp-sub { font-size: 0.95rem; font-weight: bold; color: #555; }
        .rain-sub { font-size: 0.8rem; color: #666; font-weight: normal; }

        /* --- More Info Bar --- */
        .more-info-bar {
            background: #f1f3f5; border-top: 1px solid #eee;
            color: #888; font-size: 0.8rem; text-align: center;
            padding: 6px; cursor: pointer; transition: background 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .more-info-bar:hover { background: #e9ecef; color: #555; }
        .more-info-bar span { font-size: 0.7rem; transition: transform 0.3s; }
        .more-info-bar.active span { transform: rotate(180deg); }
        .more-info-bar.active { background: #e3e6ea; border-bottom: 1px solid #ddd; }

        .forecast-table {
            width: 100%; border-collapse: collapse; font-size: 0.9rem; 
            display: none; background: white;
        }
        .forecast-table.show { display: table; }
        .forecast-table th { background: #fafafa; padding: 8px; font-size: 0.8rem; color: #666; border-bottom: 1px solid #eee;}
        .forecast-table td { padding: 10px; text-align: center; border-bottom: 1px solid #f0f0f0; }

        @media (max-width: 600px) {
            .location-row { flex-direction: column; min-height: auto; }
            .loc-header {
                width: 100%; flex-direction: row; padding: 8px; justify-content: flex-start; gap: 10px;
                background: linear-gradient(90deg, #2c3e50, #4ca1af);
            }
            .loc-title, .loc-sub { writing-mode: horizontal-tb; font-size: 1.1rem; margin: 0; letter-spacing: 1px; }
            .loc-sub::before { content: "("; } .loc-sub::after { content: ")"; }
            
            .info-top { flex-direction: column; gap: 10px; }
            .weather-big { flex-direction: row; align-items: baseline; gap: 10px; justify-content: flex-start; width: 100%; }
            .weather-temp { font-size: 3.5rem; }
            .rec-box { width: 100%; box-sizing: border-box; }
            .light-block { flex: 0 0 26%; min-width: 85px; }
        }

        .loading { color: white; text-align: center; padding: 40px; font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .error-msg { background: white; color: #d32f2f; padding: 15px; border-radius: 8px; margin: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: pre-line; word-break: break-all;}
        footer { margin-top: 30px; color: rgba(255,255,255,0.7); text-align: center; padding: 20px; font-size: 0.8rem; }
        .debug-box { background: #222; color: #0f0; padding: 10px; margin: 10px; font-family: monospace; font-size: 0.7rem; border-radius: 5px; max-height: 200px; overflow: auto; display: none; text-align: left; }
    </style>
</head>
<body>

<header>
    <div class="app-name">ğŸƒ è¦å‹•ä¸€å‹•å—?</div>
    <div class="header-actions">
        <button class="btn-reload" onclick="window.location.reload()">â†» é‡æ•´</button>
    </div>
</header>

<div class="container">
    <div id="loading" class="loading">
        æ­£åœ¨åˆ†æå¤©æ°£æ•¸æ“š...<br>
        <small>é€£ç·šè‡³ CWA API (é€¾æ™‚: 10ç§’)</small>
    </div>
    <div id="error-display" class="error-msg" style="display:none;"></div>
    <div id="debug-info" class="debug-box"></div>

    <!-- Row 1: ä¿¡ç¾©å€ -->
    <div id="card-xinyi" class="location-row" style="display:none;">
        <div class="loc-header">
            <div class="loc-title">ä¿¡ç¾©å€</div>
            <div class="loc-sub">å…­å¼µçŠ</div>
        </div>
        <div class="loc-content">
            <div class="loc-main-data">
                <div class="update-tag" id="update-time-xinyi">--:--</div>
                
                <div class="info-top">
                    <div class="weather-big">
                        <div class="weather-temp" id="curr-temp-xinyi">--Â°</div>
                        <div class="weather-desc">
                            <span id="curr-desc-xinyi">--</span>
                            <div style="font-size:0.9rem; color:#666; font-weight:normal;">é™é›¨æ©Ÿç‡ <span id="curr-pop-xinyi">--</span>%</div>
                        </div>
                    </div>
                    
                    <!-- Recommendations (Horizontal) -->
                    <div class="rec-box">
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-u-xinyi">--</span>
                            <span class="rec-text" id="text-u-xinyi">--</span>
                        </div>
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-c-xinyi">--</span>
                            <span class="rec-text" id="text-c-xinyi">--</span>
                        </div>
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-s-xinyi">--</span>
                            <span class="rec-text" id="text-s-xinyi">--</span>
                        </div>
                    </div>
                </div>

                <div class="timeline-container">
                    <div class="timeline-header">
                        <span>æœªä¾† 24 å°æ™‚è¶¨å‹¢</span>
                        <span style="opacity:0.6;">â† æ»‘å‹• â†’</span>
                    </div>
                    <div class="traffic-lights" id="lights-xinyi"></div>
                </div>
            </div>

            <!-- More Bar -->
            <div class="more-info-bar" onclick="toggleDetails('table-xinyi', this)">
                è©³ç´°æ•¸æ“š <span>â–¼</span>
            </div>
            <table id="table-xinyi" class="forecast-table">
                <thead><tr><th>æ™‚é–“</th><th>æº«åº¦</th><th>å¤©æ°£</th><th>é™é›¨</th></tr></thead>
                <tbody id="tbody-xinyi"></tbody>
            </table>
        </div>
    </div>

    <!-- Row 2: æ–°åº—å€ -->
    <div id="card-xindian" class="location-row" style="display:none;">
        <div class="loc-header">
            <div class="loc-title">æ–°åº—å€</div>
            <div class="loc-sub">å¤®åŒ—/åå››å¼µ</div>
        </div>
        <div class="loc-content">
            <div class="loc-main-data">
                <div class="update-tag" id="update-time-xindian">--:--</div>
                
                <div class="info-top">
                    <div class="weather-big">
                        <div class="weather-temp" id="curr-temp-xindian">--Â°</div>
                        <div class="weather-desc">
                            <span id="curr-desc-xindian">--</span>
                            <div style="font-size:0.9rem; color:#666; font-weight:normal;">é™é›¨æ©Ÿç‡ <span id="curr-pop-xindian">--</span>%</div>
                        </div>
                    </div>
                    
                    <div class="rec-box">
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-u-xindian">--</span>
                            <span class="rec-text" id="text-u-xindian">--</span>
                        </div>
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-c-xindian">--</span>
                            <span class="rec-text" id="text-c-xindian">--</span>
                        </div>
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-s-xindian">--</span>
                            <span class="rec-text" id="text-s-xindian">--</span>
                        </div>
                    </div>
                </div>

                <div class="timeline-container">
                    <div class="timeline-header">
                        <span>æœªä¾† 24 å°æ™‚è¶¨å‹¢</span>
                        <span style="opacity:0.6;">â† æ»‘å‹• â†’</span>
                    </div>
                    <div class="traffic-lights" id="lights-xindian"></div>
                </div>
            </div>

            <div class="more-info-bar" onclick="toggleDetails('table-xindian', this)">
                è©³ç´°æ•¸æ“š <span>â–¼</span>
            </div>
            <table id="table-xindian" class="forecast-table">
                <thead><tr><th>æ™‚é–“</th><th>æº«åº¦</th><th>å¤©æ°£</th><th>é™é›¨</th></tr></thead>
                <tbody id="tbody-xindian"></tbody>
            </table>
        </div>
    </div>

</div>

<footer>
    <div>Data Source: CWA Open Data</div>
    <div class="build-info">Build# 2025120515 (TimeoutFix)</div>
    <div class="release-notes" style="margin-top:10px; font-size:0.75rem; color:#aaa;">
        <strong>Release Notes v1.0.30:</strong>
        <br>- ä¿®æ­£å¡ä½å•é¡Œï¼šæ–°å¢ 10 ç§’ API è«‹æ±‚é€¾æ™‚ (Timeout) è¨­å®šã€‚
        <br>- å¼·åˆ¶åˆ·æ–°ï¼šAPI è«‹æ±‚åŠ å…¥æ™‚é–“æˆ³è¨˜ï¼Œé¿å…è®€å–åˆ°èˆŠçš„å¿«å–è³‡æ–™ã€‚
    </div>
</footer>

<script>
    const CONFIG = {
        loc1: { dataId: "F-D0047-061", district: "ä¿¡ç¾©å€", uiId: "xinyi" },
        loc2: { dataId: "F-D0047-069", district: "æ–°åº—å€", uiId: "xindian" }
    };
    const ENC_KEY = "Q1dBLTcwNENBMjRGLTM5OEMtNEYzRi1BRDU3LUI2OUYzMkY5NkU0Mg==";
    const API_KEY = atob(ENC_KEY);

    document.addEventListener("DOMContentLoaded", () => {
        initWeather();
    });

    async function initWeather() {
        try {
            document.getElementById("error-display").style.display = "none";
            
            // ä½¿ç”¨ Promise.allSettled ç¢ºä¿ä¸€å€‹å¤±æ•—ä¸æœƒå¡æ­»å…¨éƒ¨ (é›–ç„¶é€™è£¡ç”¨ all ä¹Ÿå¯ä»¥ï¼Œä½†æœ‰ timeout ä¿è­·)
            await Promise.all([ 
                fetchAndRender(CONFIG.loc1), 
                fetchAndRender(CONFIG.loc2) 
            ]);
            
            document.getElementById("loading").style.display = "none";
            document.getElementById("card-xinyi").style.display = "flex";
            document.getElementById("card-xindian").style.display = "flex";
        } catch (error) {
            console.error(error);
            document.getElementById("loading").style.display = "none";
            const err = document.getElementById("error-display");
            err.style.display = "block";
            err.innerText = "è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚\n" + error.message;
        }
    }

    // å°è£ Fetchï¼ŒåŠ å…¥ Timeout åŠŸèƒ½
    async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 10000 } = options; // 10ç§’é è¨­
        
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        
        try {
            const response = await fetch(resource, {
                ...options,
                signal: controller.signal  
            });
            clearTimeout(id);
            return response;
        } catch (error) {
            clearTimeout(id);
            throw error;
        }
    }

    async function fetchAndRender(loc) {
        // åŠ å…¥æ™‚é–“æˆ³è¨˜é¿å…å¿«å–
        const timestamp = new Date().getTime();
        const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/${loc.dataId}?Authorization=${API_KEY}&locationName=${encodeURIComponent(loc.district)}&_t=${timestamp}`;
        
        const res = await fetchWithTimeout(url, { timeout: 10000 }); // è¨­å®š 10 ç§’é€¾æ™‚
        
        if (!res.ok) {
            throw new Error(`API Error ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();
        
        if (data.success === "false") throw new Error(data.message.text);
        
        const records = data.records || data.Records;
        if (!records) throw new Error("API Records missing");
        
        const locWrap = records.locations || records.Locations;
        if (!locWrap || locWrap.length === 0) throw new Error("API Locations missing");
        
        const locList = locWrap[0].location || locWrap[0].Location;
        if (!locList || locList.length === 0) throw new Error(`æ‰¾ä¸åˆ°åœ°å€è³‡æ–™: ${loc.district}`);
        
        const elements = locList[0].weatherElement || locList[0].WeatherElement;
        const processed = processData(elements, loc.uiId);
        renderUI(loc.uiId, processed);
    }

    function getValue(obj) {
        if (!obj) return null;
        if (obj["value"] !== undefined) return obj["value"];
        if (obj["Value"] !== undefined) return obj["Value"];
        if (obj["ProbabilityOfPrecipitation"] !== undefined) return obj["ProbabilityOfPrecipitation"];
        if (obj["Temperature"] !== undefined) return obj["Temperature"];
        const values = Object.values(obj);
        if (values.length > 0) return values[0];
        return null;
    }

    function getProp(obj, propName) {
        if (!obj) return null;
        if (obj[propName] !== undefined) return obj[propName];
        if (obj[propName.toLowerCase()] !== undefined) return obj[propName.toLowerCase()];
        const cap = propName.charAt(0).toUpperCase() + propName.slice(1);
        if (obj[cap] !== undefined) return obj[cap];
        return null;
    }

    function getEl(elements, possibleNames) {
        return elements.find(e => {
            const name = e.elementName || e.ElementName;
            return possibleNames.includes(name);
        });
    }

    function processData(elements, uiId) {
        const rawT = getEl(elements, ["T", "æº«åº¦"]);
        if(!rawT) return [];

        const T_list = getProp(rawT, "time");
        const rawWx = getEl(elements, ["Wx", "å¤©æ°£ç¾è±¡"]);
        const Wx_list = rawWx ? getProp(rawWx, "time") : [];
        const rawPoP = getEl(elements, ["PoP3h", "3å°æ™‚é™é›¨æ©Ÿç‡", "PoP12h", "PoP6h"]);
        const PoP_list = rawPoP ? getProp(rawPoP, "time") : [];
        const rawRain = getEl(elements, ["Rain", "Rainfall", "é›¨é‡"]); 
        const Rain_list = rawRain ? getProp(rawRain, "time") : [];

        let result = [];
        T_list.forEach(t => {
            let startStr = t.startTime || t.StartTime || t.dataTime || t.DataTime;
            let endStr = t.endTime || t.EndTime;
            const start = new Date(startStr);
            let end;
            if (endStr) end = new Date(endStr);
            else end = new Date(start.getTime() + 3 * 60 * 60 * 1000);

            const tVals = getProp(t, "elementValue");
            if(!tVals || tVals.length === 0) return;
            const tValStr = getValue(tVals[0]);
            const tVal = parseInt(tValStr);
            
            const wxItem = Wx_list.find(w => {
                const wS = w.startTime || w.StartTime || w.dataTime || w.DataTime;
                return new Date(wS).getTime() === start.getTime();
            });
            let wxDesc = "-", wxCode = 0;
            if(wxItem) {
                const wVals = getProp(wxItem, "elementValue");
                if(wVals && wVals.length > 0) wxDesc = getValue(wVals[0]);
                if(wVals && wVals.length > 1) wxCode = parseInt(getValue(wVals[1]));
            }

            // PoP
            let popVal = "0";
            let popItem = PoP_list.find(p => {
                const pS = p.startTime || p.StartTime || p.dataTime || p.DataTime;
                return new Date(pS).getTime() === start.getTime();
            });
            
            if (!popItem) {
                popItem = PoP_list.find(p => {
                    const ps = new Date(p.startTime || p.StartTime);
                    const pe = new Date(p.endTime || p.EndTime);
                    return (start < pe && end > ps);
                });
            }
            if(popItem) {
                const pVals = getProp(popItem, "elementValue");
                if(pVals && pVals.length > 0) popVal = getValue(pVals[0]);
            }

            let rainVal = null;
            if (Rain_list.length > 0) {
                const rItem = Rain_list.find(r => {
                    const rS = r.startTime || r.StartTime || r.dataTime || r.DataTime;
                    return new Date(rS).getTime() === start.getTime();
                });
                if (rItem) {
                    const rVals = getProp(rItem, "elementValue");
                    if(rVals && rVals.length > 0) rainVal = getValue(rVals[0]);
                }
            }

            result.push({
                start, end, temp: tVal, wx: wxDesc, code: wxCode, pop: popVal, rain: rainVal
            });
        });
        return result.sort((a,b) => a.start - b.start);
    }

    function renderUI(uiId, data) {
        if(!data || data.length === 0) return;

        const now = new Date();
        let future = data.filter(d => d.end > now);
        if (future.length === 0 && data.length > 0) future = data.slice(-3);
        if (future.length === 0) return;

        let list = [];
        let cursor = null;
        future.forEach(item => {
            if (!cursor || item.start >= cursor) {
                list.push(item);
                cursor = item.end;
            }
        });

        const cur = list[0];
        
        const displayTemp = isNaN(cur.temp) ? "--" : cur.temp;
        const displayPop = (cur.pop === null || cur.pop === " " || isNaN(parseInt(cur.pop))) ? "0" : cur.pop;

        document.getElementById(`curr-temp-${uiId}`).innerText = `${displayTemp}Â°`;
        document.getElementById(`curr-desc-${uiId}`).innerText = cur.wx;
        document.getElementById(`curr-pop-${uiId}`).innerText = displayPop;
        
        const d = new Date();
        document.getElementById(`update-time-${uiId}`).innerText = `æ›´æ–°: ${pad(d.getHours())}:${pad(d.getMinutes())}`;

        const rec = getRec(cur.temp, parseInt(displayPop), cur.code);
        document.getElementById(`icon-u-${uiId}`).innerText = rec.u.i;
        document.getElementById(`text-u-${uiId}`).innerText = rec.u.t;
        
        document.getElementById(`icon-c-${uiId}`).innerText = rec.c.i;
        document.getElementById(`text-c-${uiId}`).innerText = rec.c.t;
        
        document.getElementById(`icon-s-${uiId}`).innerText = rec.s.i;
        document.getElementById(`text-s-${uiId}`).innerText = rec.s.t;

        // Lights
        const lights = document.getElementById(`lights-${uiId}`);
        lights.innerHTML = "";
        list.slice(0, 8).forEach(slot => {
            const st = getStatus(slot);
            const div = document.createElement("div");
            div.className = "light-block";
            div.style.backgroundColor = st.color;
            
            let pVal = (slot.pop === null || slot.pop === " ") ? "0" : slot.pop;
            let tVal = isNaN(slot.temp) ? "--" : slot.temp;

            let rainTxt = `é›¨ ${pVal}%`;
            if (slot.rain && slot.rain !== "0" && slot.rain !== "0.0") rainTxt += `<br><span class="rain-mm">é‡${slot.rain}mm</span>`;

            div.innerHTML = `
                <div class="time-label">${formatH(slot.start.getHours())}~${formatH(slot.end.getHours())}</div>
                <div class="status-emoji">${st.emoji}</div>
                <div class="status-text">${st.text}</div>
                <div class="temp-sub">
                    <div>${tVal}Â°</div>
                    <div class="rain-sub">${rainTxt}</div>
                </div>
            `;
            lights.appendChild(div);
        });

        // Table
        const tb = document.getElementById(`tbody-${uiId}`);
        tb.innerHTML = "";
        list.slice(0, 16).forEach(d => {
            let pVal = (d.pop === null || d.pop === " ") ? "0" : d.pop;
            let tVal = isNaN(d.temp) ? "--" : d.temp;
            tb.innerHTML += `<tr>
                <td>${d.start.getMonth()+1}/${d.start.getDate()} <br>${formatH(d.start.getHours())}~${formatH(d.end.getHours())}</td>
                <td>${tVal}Â°</td><td>${d.wx}</td><td>${pVal}%</td>
            </tr>`;
        });
    }

    function getStatus(d) {
        let s = 4; 
        const pop = parseInt(d.pop) || 0;
        
        if (pop >= 60) s = 1; 
        else if (pop >= 30) s = 2; 
        else if (pop >= 20) s = 3; 

        if (d.code >= 15 && d.code <= 22) s = 1; 
        
        if (d.temp > 35 || d.temp < 10) s = Math.min(s, 2);
        else if (d.temp > 31 || d.temp < 14) s = Math.min(s, 3);
        else if (d.temp >= 19 && d.temp <= 27 && pop < 15) s = 5; 

        const map = {
            1: { color: "#ef9a9a", text: "Sleep", emoji: "ğŸ˜´" },
            2: { color: "#ffcc80", text: "Light Rain", emoji: "ğŸŒ§ï¸" },
            3: { color: "#fff59d", text: "Nice", emoji: "ğŸ˜Š" },
            4: { color: "#81d4fa", text: "Comfy", emoji: "ğŸ¤©" },
            5: { color: "#a5d6a7", text: "Great!", emoji: "ğŸ‰" }
        };
        return map[s] || map[3];
    }

    function getRec(t, p, c) {
        let u = { i: "ğŸŒ‚", t: "ä¸ç”¨å¸¶å‚˜" };
        let cl = { i: "ğŸ‘•", t: "èˆ’é©ç©¿è‘—" };
        let sp = { i: "ğŸƒ", t: "é©åˆæˆ¶å¤–" };

        if (p >= 50 || (c >= 11 && c <= 22)) u = { i: "â˜”", t: "å‹™å¿…å¸¶å‚˜" };
        else if (p >= 20) u = { i: "â˜‚ï¸", t: "å»ºè­°æŠ˜å‚˜" };

        if (t < 15) cl = { i: "ğŸ§¥", t: "æ´‹è”¥ä¿æš–" };
        else if (t < 20) cl = { i: "ğŸ‘”", t: "é•·è¢–å¤–å¥—" };
        else if (t > 28) cl = { i: "ğŸ½", t: "çŸ­è¢–é€æ°£" };
        else if (t > 32) cl = { i: "ğŸ§¢", t: "æ³¨æ„é˜²æ›¬" };

        // çµ±ä¸€é‚è¼¯ï¼šé™é›¨æ©Ÿç‡ >= 40% å»ºè­°å®¤å…§
        if (p >= 40) sp = { i: "ğŸ ", t: "å®¤å…§é‹å‹•" }; 
        else if (p >= 20) sp = { i: "ğŸ¦¶", t: "å°å¿ƒæ¿•æ»‘" };
        else if (t > 33) sp = { i: "ğŸ’§", t: "æ³¨æ„è£œæ°´" };
        else if (t < 12) sp = { i: "ğŸ”¥", t: "æ³¨æ„æš–èº«" };

        return { u, c: cl, s: sp };
    }

    function pad(n) { return n.toString().padStart(2,'0'); }
    function formatH(h) { return pad(h); }
    function toggleDetails(id, btn) { 
        document.getElementById(id).classList.toggle("show"); 
        btn.classList.toggle("active");
    }
</script>

</body>
</html>