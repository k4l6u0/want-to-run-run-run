<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›™å€æˆ¶å¤–é‹å‹•æ°£è±¡é æ¸¬</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            
            /* 5 Levels Colors (Light Pastels) */
            --level-rest: #ef9a9a;       /* æ·ºç´… - ä¼‘æ¯ */
            --level-bad: #ffcc80;        /* æ·ºæ©˜ - å‹‰å¼· */
            --level-ok: #fff59d;         /* æ·ºé»ƒ - å°šå¯ */
            --level-good: #81d4fa;       /* æ·ºè— - ä¸éŒ¯ */
            --level-excellent: #a5d6a7;  /* æ·ºç¶  - éå¸¸å¥½ */
        }

        body {
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-main);
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .build-info {
            font-family: monospace;
            opacity: 0.8;
            font-size: 0.8rem;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .location-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .card-header {
            padding: 15px 20px;
            background: #eceff1;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.4rem;
            color: #2c3e50;
        }
        
        .sub-location {
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-left: 10px;
        }

        .card-body { padding: 20px; }

        .current-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .weather-main { flex: 1; min-width: 150px; }
        .weather-temp { font-size: 2.5rem; font-weight: bold; }
        .weather-desc { font-size: 1.1rem; color: var(--text-sub); }

        .recommendation {
            flex: 2;
            min-width: 200px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            line-height: 1.8;
        }

        .activity-section { margin-top: 10px; }
        .activity-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .traffic-lights {
            display: flex;
            height: 110px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .light-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #333;
            border-right: 1px solid rgba(255,255,255,0.5);
            position: relative;
            padding: 0 5px;
        }
        .light-block:last-child { border-right: none; }

        .time-label { 
            font-size: 0.8rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
            white-space: nowrap; 
        }
        .status-label { font-size: 1rem; font-weight: bold; }
        .temp-sub { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; }

        .details-toggle {
            display: block;
            margin-top: 15px;
            text-align: center;
            color: #007bff;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
        }

        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
        }
        .forecast-table.show { display: table; }
        .forecast-table th, .forecast-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .forecast-table th { background-color: #f8f9fa; }

        .loading { text-align: center; padding: 30px; font-size: 1.2rem; color: #666; }
        .error-msg { 
            color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; 
            padding: 15px; border-radius: 5px; margin: 20px; white-space: pre-line;
            text-align: left; font-family: monospace; font-size: 0.85rem;
        }
        .debug-data-dump {
            background: #333; color: #0f0; padding: 15px; margin: 20px 0;
            font-family: monospace; font-size: 0.8rem; overflow-x: auto;
            border-radius: 5px; white-space: pre-wrap; display: none;
        }

        footer {
            margin-top: 40px;
            background: #fff;
            padding: 20px;
            border-top: 1px solid #ddd;
            font-size: 0.85rem;
            color: var(--text-sub);
        }
    </style>
</head>
<body>

<header>
    <div class="app-name">ğŸŒ¤ï¸ é›™å€æ°£è±¡é‹å‹•æŒ‡å¼•</div>
    <div class="build-info">Build# 2025120413 (KeyMask)</div>
</header>

<div class="container">
    <div id="mainContent">
        <div id="loading" class="loading">
            æ­£åœ¨é€£ç·šè‡³æ°£è±¡ç½²å–å¾— 3 å°æ™‚é å ±...<br>
            <small style="font-size:0.9rem">F-D0047-061/069</small>
        </div>
        
        <div id="error-display" class="error-msg" style="display:none;"></div>
        <div id="debug-area" class="debug-data-dump"></div>

        <!-- ä¿¡ç¾©å€ -->
        <div id="card-xinyi" class="location-card" style="display:none;">
            <div class="card-header">
                <h2>ä¿¡ç¾©å€ <span class="sub-location">(å…­å¼µçŠ)</span></h2>
                <span id="update-time-xinyi" style="font-size:0.8rem; color:#888;">--:--</span>
            </div>
            <div class="card-body">
                <div class="current-summary">
                    <div class="weather-main">
                        <div class="weather-temp" id="curr-temp-xinyi">--Â°C</div>
                        <div class="weather-desc" id="curr-desc-xinyi">--</div>
                        <div style="font-size:0.9rem; color:#555;">é™é›¨æ©Ÿç‡: <span id="curr-pop-xinyi">--</span>%</div>
                    </div>
                    <div class="recommendation">
                        <div class="rec-item">â˜‚ï¸ <span id="rec-umbrella-xinyi">--</span></div>
                        <div class="rec-item">ğŸ‘• <span id="rec-cloth-xinyi">--</span></div>
                        <div class="rec-item">ğŸƒ <span id="rec-sport-xinyi">--</span></div>
                    </div>
                </div>

                <div class="activity-section">
                    <div class="activity-title">æœªä¾† 12 å°æ™‚é‹å‹•å»ºè­° (3å°æ™‚å€é–“)</div>
                    <div class="traffic-lights" id="lights-xinyi"></div>
                </div>

                <div class="details-toggle" onclick="toggleDetails('table-xinyi')">æŸ¥çœ‹è©³ç´°é å ± (æœªä¾†2å¤© / ä¸é‡ç–Šå€é–“)</div>
                <table id="table-xinyi" class="forecast-table">
                    <thead><tr><th>æ™‚é–“</th><th>æº«åº¦</th><th>å¤©æ°£</th><th>é™é›¨æ©Ÿç‡</th></tr></thead>
                    <tbody id="tbody-xinyi"></tbody>
                </table>
            </div>
        </div>

        <!-- æ–°åº—å€ -->
        <div id="card-xindian" class="location-card" style="display:none;">
            <div class="card-header">
                <h2>æ–°åº—å€ <span class="sub-location">(å¤®åŒ—/åå››å¼µ)</span></h2>
                <span id="update-time-xindian" style="font-size:0.8rem; color:#888;">--:--</span>
            </div>
            <div class="card-body">
                <div class="current-summary">
                    <div class="weather-main">
                        <div class="weather-temp" id="curr-temp-xindian">--Â°C</div>
                        <div class="weather-desc" id="curr-desc-xindian">--</div>
                        <div style="font-size:0.9rem; color:#555;">é™é›¨æ©Ÿç‡: <span id="curr-pop-xindian">--</span>%</div>
                    </div>
                    <div class="recommendation">
                        <div class="rec-item">â˜‚ï¸ <span id="rec-umbrella-xindian">--</span></div>
                        <div class="rec-item">ğŸ‘• <span id="rec-cloth-xindian">--</span></div>
                        <div class="rec-item">ğŸƒ <span id="rec-sport-xindian">--</span></div>
                    </div>
                </div>

                <div class="activity-section">
                    <div class="activity-title">æœªä¾† 12 å°æ™‚é‹å‹•å»ºè­° (3å°æ™‚å€é–“)</div>
                    <div class="traffic-lights" id="lights-xindian"></div>
                </div>

                <div class="details-toggle" onclick="toggleDetails('table-xindian')">æŸ¥çœ‹è©³ç´°é å ± (æœªä¾†2å¤© / ä¸é‡ç–Šå€é–“)</div>
                <table id="table-xindian" class="forecast-table">
                    <thead><tr><th>æ™‚é–“</th><th>æº«åº¦</th><th>å¤©æ°£</th><th>é™é›¨æ©Ÿç‡</th></tr></thead>
                    <tbody id="tbody-xindian"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="release-notes">
        <h4>Release Notes (v1.0.13)</h4>
        <ul>
            <li><strong>UI:</strong> ç¶­æŒæ·ºè‰²ç³»ç‡ˆè™Ÿèˆ‡ 12 å°æ™‚åˆ¶ä¸é‡ç–Šå€é–“ã€‚</li>
        </ul>
        <p style="margin-top:10px;">è³‡æ–™ä¾†æº: ä¸­å¤®æ°£è±¡ç½² (CWA)</p>
    </div>
</footer>

<script>
    const CONFIG = {
        loc1: { dataId: "F-D0047-061", district: "ä¿¡ç¾©å€", uiId: "xinyi" },
        loc2: { dataId: "F-D0047-069", district: "æ–°åº—å€", uiId: "xindian" }
    };

    // Obfuscated Key (Base64 Encoded)
    // åŸå€¼: CWA-704CA24F-398C-4F3F-AD57-B69F32F96E42
    const ENC_KEY = "Q1dBLTcwNENBMjRGLTM5OEMtNEYzRi1BRDU3LUI2OUYzMkY5NkU0Mg==";
    
    // Decode at runtime
    const API_KEY = atob(ENC_KEY);

    document.addEventListener("DOMContentLoaded", () => {
        initWeather();
    });

    async function initWeather() {
        try {
            document.getElementById("error-display").style.display = "none";
            document.getElementById("debug-area").style.display = "none";
            
            await Promise.all([
                fetchAndRender(CONFIG.loc1),
                fetchAndRender(CONFIG.loc2)
            ]);
            document.getElementById("loading").style.display = "none";
            document.getElementById("card-xinyi").style.display = "block";
            document.getElementById("card-xindian").style.display = "block";
        } catch (error) {
            console.error("Main Error:", error);
            document.getElementById("loading").style.display = "none";
            const errDiv = document.getElementById("error-display");
            errDiv.style.display = "block";
            errDiv.innerHTML = `<strong>ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼š</strong><br>${error.message}`;
        }
    }

    async function fetchAndRender(locConfig) {
        const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/${locConfig.dataId}?Authorization=${API_KEY}&locationName=${encodeURIComponent(locConfig.district)}`;
        
        const response = await fetch(url);
        const data = await response.json();

        if (data.success === "false") {
            throw new Error(`API æˆæ¬Šå¤±æ•—: ${data.message.text || "æœªçŸ¥åŸå› "}`);
        }

        const records = data.records || data.Records;
        const locationsWrapper = records.locations || records.Locations;
        const locationArr = locationsWrapper[0].location || locationsWrapper[0].Location;

        if (!locationArr || locationArr.length === 0) {
            throw new Error(`æ‰¾ä¸åˆ°ã€Œ${locConfig.district}ã€çš„è³‡æ–™ã€‚`);
        }

        const locationData = locationArr[0];
        const weatherElements = locationData.weatherElement || locationData.WeatherElement;
        
        try {
            const forecastList = processWeatherData(weatherElements, locConfig.district, locConfig.uiId);
            renderUI(locConfig.uiId, forecastList);
        } catch (e) {
            const debugEl = document.getElementById("debug-area");
            debugEl.style.display = "block";
            debugEl.innerText += `\n--- Debug Info (${locConfig.district}) ---\nError: ${e.message}\nRaw Elements (Names): ${weatherElements.map(x=>x.elementName || x.ElementName).join(", ")}\n`;
            throw e;
        }
    }

    function processWeatherData(elements, districtName, uiId) {
        const getEl = (names) => elements.find(e => names.includes(e.elementName || e.ElementName));
        
        const elT = getEl(["T", "æº«åº¦", "å¹³å‡æº«åº¦"]);
        if (!elT) throw new Error("æ‰¾ä¸åˆ°æº«åº¦æ¬„ä½");
        const T_list = elT.time || elT.Time;
        
        const elWx = getEl(["Wx", "å¤©æ°£ç¾è±¡"]);
        const Wx_list = elWx ? (elWx.time || elWx.Time) : [];
        const elPoP = getEl(["PoP3h", "3å°æ™‚é™é›¨æ©Ÿç‡", "PoP12h", "12å°æ™‚é™é›¨æ©Ÿç‡", "PoP6h", "6å°æ™‚é™é›¨æ©Ÿç‡"]);
        const PoP_list = elPoP ? (elPoP.time || elPoP.Time) : [];

        let result = [];
        
        T_list.forEach((tItem) => {
            const startStr = tItem.startTime || tItem.StartTime || tItem.dataTime || tItem.DataTime;
            const endStr = tItem.endTime || tItem.EndTime;
            
            const startTime = new Date(startStr);
            let endTime;

            if (endStr) {
                endTime = new Date(endStr);
            } else {
                endTime = new Date(startTime.getTime() + 3 * 60 * 60 * 1000);
            }
            
            const tVals = tItem.elementValue || tItem.ElementValue;
            let tempVal = tVals[0].value || tVals[0].Temperature;
            tempVal = parseInt(tempVal);

            const wxItem = Wx_list.find(w => {
                const wStartStr = w.startTime || w.StartTime || w.dataTime || w.DataTime;
                return new Date(wStartStr).getTime() === startTime.getTime();
            });
            const wxVals = wxItem ? (wxItem.elementValue || wxItem.ElementValue) : [];
            const wxDesc = wxVals.length > 0 ? (wxVals[0].value || wxVals[0].Weather) : "-";
            const wxCodeVal = wxVals.length > 1 ? parseInt(wxVals[1].value) : 0; 

            const popItem = PoP_list.find(p => {
                const pStartStr = p.startTime || p.StartTime || p.dataTime || p.DataTime;
                return new Date(pStartStr).getTime() === startTime.getTime();
            });
            
            let popVal = "0";
            if (popItem) {
                const pVals = popItem.elementValue || popItem.ElementValue;
                popVal = pVals[0].value || pVals[0].ProbabilityOfPrecipitation;
            } else {
                const popOverlap = PoP_list.find(p => {
                    const pS = new Date(p.startTime || p.StartTime);
                    const pE = new Date(p.endTime || p.EndTime);
                    return (startTime < pE && endTime > pS);
                });
                if (popOverlap) {
                    const pVals = popOverlap.elementValue || popOverlap.ElementValue;
                    popVal = pVals[0].value || pVals[0].ProbabilityOfPrecipitation;
                }
            }

            if (!popVal || popVal === " " || popVal === "null") popVal = "0";

            result.push({
                startTime: startTime,
                endTime: endTime,
                temp: tempVal,
                wx: wxDesc,
                wxCode: wxCodeVal,
                pop: popVal
            });
        });

        result.sort((a, b) => a.startTime - b.startTime);
        return result;
    }

    function renderUI(uiId, data) {
        const now = new Date();
        let futureData = data.filter(d => d.endTime > now);
        
        if (futureData.length === 0 && data.length > 0) {
            console.warn(`${uiId}: No future data. Showing recent.`);
            futureData = data.slice(-3); 
            const errDiv = document.getElementById("error-display");
            errDiv.style.display = "block";
            errDiv.innerHTML += `${uiId}: æš«ç„¡æœ€æ–°æœªä¾†é å ±ï¼Œé¡¯ç¤ºæœ€è¿‘è³‡æ–™ã€‚<br>`;
        }

        if (futureData.length === 0) return;

        const current = futureData[0];

        // æ‘˜è¦
        document.getElementById(`curr-temp-${uiId}`).innerText = `${current.temp}Â°C`;
        document.getElementById(`curr-desc-${uiId}`).innerText = current.wx;
        document.getElementById(`curr-pop-${uiId}`).innerText = current.pop;
        
        const updateT = new Date();
        document.getElementById(`update-time-${uiId}`).innerText = 
            `æ›´æ–°: ${updateT.getHours().toString().padStart(2,'0')}:${updateT.getMinutes().toString().padStart(2,'0')}`;

        const recs = getRecommendations(current.temp, parseInt(current.pop), current.wx);
        document.getElementById(`rec-umbrella-${uiId}`).innerText = recs.umbrella;
        document.getElementById(`rec-cloth-${uiId}`).innerText = recs.cloth;
        document.getElementById(`rec-sport-${uiId}`).innerText = recs.sport;

        // --- å»ºç«‹ä¸é‡ç–Šæ¸…å–® (Distinct List) ---
        let distinctList = [];
        let cursorTime = null;

        for (let i = 0; i < futureData.length; i++) {
            const item = futureData[i];
            
            if (distinctList.length === 0) {
                distinctList.push(item);
                cursorTime = item.endTime;
            } else {
                // ç¢ºä¿ä¸‹ä¸€ç­†çš„é–‹å§‹æ™‚é–“ >= ä¸Šä¸€ç­†çš„çµæŸæ™‚é–“
                if (item.startTime.getTime() >= cursorTime.getTime()) {
                    distinctList.push(item);
                    cursorTime = item.endTime;
                }
            }
        }

        // 1. ç‡ˆè™Ÿ (å–å‰ 4 ç­†)
        const lightsContainer = document.getElementById(`lights-${uiId}`);
        lightsContainer.innerHTML = "";
        
        distinctList.slice(0, 4).forEach(slot => {
            const score = calculateActivityScore(slot);
            const colorInfo = getScoreColor(score);
            
            const div = document.createElement("div");
            div.className = "light-block"; 
            div.style.backgroundColor = colorInfo.color;
            
            const startH = slot.startTime.getHours();
            const endH = slot.endTime.getHours();
            
            div.innerHTML = `
                <div class="time-label">${formatHour12(startH)}-${formatHour12(endH)}</div>
                <div class="status-label">${colorInfo.text}</div>
                <div class="temp-sub">${slot.temp}Â°C / ${slot.pop}%</div>
            `;
            lightsContainer.appendChild(div);
        });

        // 2. è¡¨æ ¼ (é¡¯ç¤ºæ›´å¤šä¸é‡ç–Šçš„å€é–“ï¼Œä¾‹å¦‚å‰ 16 ç­† = 48å°æ™‚)
        const tbody = document.getElementById(`tbody-${uiId}`);
        tbody.innerHTML = "";
        distinctList.slice(0, 16).forEach(d => {
            const row = `<tr>
                <td>${formatDate(d.startTime)} <br> ${formatHour12(d.startTime.getHours())}~${formatHour12(d.endTime.getHours())}</td>
                <td>${d.temp}Â°C</td>
                <td>${d.wx}</td>
                <td>${d.pop}%</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function calculateActivityScore(data) {
        let score = 4;
        const temp = data.temp;
        const pop = parseInt(data.pop);
        const code = data.wxCode;
        
        // 1. Rain
        if (pop >= 60) return 1; 
        if (pop >= 30) score = 2; 
        else if (pop >= 20) score = Math.min(score, 3);

        // 2. Wx Code (Heavy Rain/Thunder)
        if (code >= 15 && code <= 22) return 1;

        // 3. Temp
        if (temp > 35 || temp < 10) score = Math.min(score, 2);
        else if (temp > 31 || temp < 14) score = Math.min(score, 3);
        else if (temp >= 19 && temp <= 27 && pop < 15) score = 5;

        return Math.max(1, score);
    }

    function getScoreColor(score) {
        switch (score) {
            case 1: return { color: "var(--level-rest)", text: "ä¼‘æ¯" };
            case 2: return { color: "var(--level-bad)", text: "å‹‰å¼·" };
            case 3: return { color: "var(--level-ok)", text: "å°šå¯" };
            case 4: return { color: "var(--level-good)", text: "ä¸éŒ¯" };
            case 5: return { color: "var(--level-excellent)", text: "éå¸¸å¥½" };
            default: return { color: "#ccc", text: "?" };
        }
    }

    function getRecommendations(temp, pop, wx) {
        let u = "ä¸ç”¨å¸¶å‚˜";
        let c = "èˆ’é©ç©¿è‘—";
        let s = "é©åˆæˆ¶å¤–é‹å‹•";

        if (pop >= 50 || (wx && wx.includes("é›¨"))) u = "å‹™å¿…å¸¶å‚˜/é›¨è¡£";
        else if (pop >= 20) u = "å»ºè­°æ”œå¸¶æŠ˜å‚˜";

        if (temp < 15) c = "æ´‹è”¥å¼/ä¿æš–";
        else if (temp < 20) c = "é•·è¢–/è–„å¤–å¥—";
        else if (temp > 28) c = "çŸ­è¢–/é€æ°£";
        else if (temp > 32) c = "æ³¨æ„é˜²æ›¬";

        if (pop > 60) s = "å»ºè­°å®¤å…§æ´»å‹•";
        else if (temp > 33) s = "æ³¨æ„ä¸­æš‘";
        else if (temp < 12) s = "æ³¨æ„æš–èº«";

        return { umbrella: u, cloth: c, sport: s };
    }

    function formatHour(h) { return h.toString().padStart(2, '0'); }
    
    function formatHour12(h) {
        const suffix = h >= 12 ? 'pm' : 'am';
        let h12 = h % 12;
        if (h12 === 0) h12 = 12; 
        return h12.toString().padStart(2, '0') + suffix;
    }

    function formatDate(date) { return `${date.getMonth()+1}/${date.getDate()}`; }
    function toggleDetails(id) { document.getElementById(id).classList.toggle("show"); }
</script>

</body>
</html>