<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë¶ÅÂãï‰∏ÄÂãïÂóé?</title>
    <style>
        :root {
            /* Background: Deep Sporty Blue */
            --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            
            /* Card: Dark Glassmorphism */
            --card-bg: rgba(30, 41, 59, 0.95); 
            
            /* Text Colors */
            --text-main: #ffffff;
            --text-sub: #cbd5e1;
            --text-muted: #94a3b8;

            /* Status Colors */
            --level-rest: #ef9a9a;       /* Sleep */
            --level-bad: #ffcc80;        /* Light Rain */
            --level-ok: #fff59d;         /* Nice */
            --level-good: #81d4fa;       /* Comfy */
            --level-excellent: #a5d6a7;  /* Great */
        }

        body {
            font-family: "Segoe UI Emoji", "Microsoft JhengHei", sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .app-name { font-size: 1.4rem; font-weight: 900; letter-spacing: 1px; font-style: italic; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .btn-reload {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        .btn-reload:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
        .build-info { font-family: monospace; opacity: 0.5; font-size: 0.7rem; color: #fff; }

        .container {
            max-width: 900px; margin: 20px auto; padding: 0 10px;
            display: flex; flex-direction: column; gap: 20px; 
        }

        /* --- Card Design --- */
        .location-row {
            display: flex; 
            background: var(--card-bg); 
            border-radius: 16px;
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            min-height: 220px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Left Header (Side Label) */
        .loc-header {
            color: #fff; width: 50px;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; padding: 10px 5px; flex-shrink: 0;
            border-right: 1px solid rgba(255,255,255,0.1);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        #card-xindian .loc-header { background: linear-gradient(180deg, #6BBF59 0%, #4c9e3d 100%); }
        #card-xinyi .loc-header { background: linear-gradient(180deg, #0073CF 0%, #0056a3 100%); }

        .loc-title { writing-mode: vertical-lr; font-size: 1.2rem; font-weight: bold; letter-spacing: 3px; text-orientation: upright; }
        .loc-sub { writing-mode: vertical-lr; font-size: 0.8rem; opacity: 0.9; margin-top: 10px; text-orientation: upright; font-weight: 500;}

        /* Right Content */
        .loc-content {
            flex: 1; padding: 0;
            display: flex; flex-direction: column;
            min-width: 0; position: relative;
        }
        
        .loc-main-data { padding: 15px 20px 10px 20px; }

        .update-tag { 
            position: absolute; top: 10px; right: 10px; 
            font-size: 0.75rem; color: #aaa; 
            background: rgba(255,255,255,0.1); 
            padding: 2px 8px; border-radius: 4px; 
        }

        /* Info Top */
        .info-top { display: flex; justify-content: space-between; align-items: stretch; margin-bottom: 20px; gap: 15px; }
        
        .weather-big { display: flex; flex-direction: column; justify-content: center; min-width: 120px;}
        .weather-temp { font-size: 3.8rem; font-weight: 800; line-height: 1; color: #fff; letter-spacing: -1px; text-shadow: 0 4px 8px rgba(0,0,0,0.15);}
        .temp-label-small { font-size: 1rem; font-weight: normal; opacity: 0.7; vertical-align: middle; margin-left: 5px; }
        .weather-desc { font-size: 1.2rem; font-weight: bold; color: var(--text-main); margin-top: 5px; opacity: 0.95;}
        .pop-label { font-size: 0.9rem; color: var(--text-sub); font-weight: 500; }
        .pop-val { color: #81d4fa; font-weight: 800; } 

        /* Rec Box */
        .rec-box {
            background: rgba(0, 0, 0, 0.2); 
            border: 1px solid rgba(255,255,255,0.05);
            padding: 12px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: stretch;
            flex: 1; gap: 5px;
        }
        .rec-item { 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; text-align: center;
            flex: 1; border-right: 1px solid rgba(255,255,255,0.1);
        }
        .rec-item:last-child { border-right: none; }
        
        .rec-emoji { font-size: 2rem; line-height: 1.2; margin-bottom: 4px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .rec-text { font-size: 0.9rem; font-weight: bold; color: #fff; line-height: 1.2; text-shadow: 0 1px 2px rgba(0,0,0,0.2);}

        /* --- Timeline --- */
        .timeline-container { margin-bottom: 15px; }
        .timeline-header { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; display: flex; justify-content: space-between; padding: 0 2px; }

        .traffic-lights {
            display: flex; height: 150px; border-radius: 12px;
            overflow-x: auto; overflow-y: hidden; 
            background: rgba(255,255,255,0.9); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            scroll-snap-type: x mandatory;
            border: none;
        }

        .traffic-lights::-webkit-scrollbar { height: 4px; }
        .traffic-lights::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .traffic-lights::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 2px; }

        .light-block {
            flex: 0 0 22%; min-width: 85px;
            display: flex; flex-direction: column; justify-content: space-evenly;
            align-items: center; text-align: center;
            border-right: 1px solid rgba(0,0,0,0.05);
            padding: 8px 2px; scroll-snap-align: start; position: relative;
        }
        .light-block:last-child { border-right: none; }

        .time-label { font-size: 0.8rem; font-weight: 800; color: #444; white-space: nowrap; opacity: 0.8;}
        .status-emoji { font-size: 2.2rem; line-height: 1; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); }
        .status-text { font-size: 1rem; font-weight: 900; color: #222; }
        .temp-sub { font-size: 1rem; font-weight: bold; color: #333; }
        .rain-sub { font-size: 0.8rem; color: #555; font-weight: bold; }
        .rain-mm { font-size: 0.7rem; color: #666; }

        /* --- More Info Bar --- */
        .more-info-bar {
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.05);
            color: #aaa; font-size: 0.8rem; text-align: center;
            padding: 10px; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .more-info-bar:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .more-info-bar span { font-size: 0.7rem; transition: transform 0.3s; }
        .more-info-bar.active span { transform: rotate(180deg); }
        .more-info-bar.active { background: rgba(0,0,0,0.4); }

        .forecast-table {
            width: 100%; border-collapse: collapse; font-size: 0.9rem; 
            display: none; background: transparent; color: #ddd;
        }
        .forecast-table.show { display: table; }
        .forecast-table th { background: rgba(0,0,0,0.3); padding: 10px; font-size: 0.8rem; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.1);}
        .forecast-table td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

        @media (max-width: 600px) {
            .location-row { flex-direction: column; min-height: auto; }
            .loc-header {
                width: 100%; flex-direction: row; padding: 10px; justify-content: flex-start; gap: 10px;
                border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            #card-xindian .loc-header { background: linear-gradient(90deg, #6BBF59 0%, #4c9e3d 100%); }
            #card-xinyi .loc-header { background: linear-gradient(90deg, #0073CF 0%, #0056a3 100%); }
            
            .loc-title, .loc-sub { writing-mode: horizontal-tb; font-size: 1.1rem; margin: 0; letter-spacing: 1px; }
            .loc-sub::before { content: "("; } .loc-sub::after { content: ")"; }
            
            .info-top { flex-direction: column; gap: 15px; }
            .weather-big { flex-direction: row; align-items: baseline; gap: 12px; justify-content: flex-start; width: 100%; }
            .rec-box { width: 100%; box-sizing: border-box; }
            .light-block { flex: 0 0 26%; min-width: 85px; }
        }

        .loading { color: white; text-align: center; padding: 40px; font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .error-msg { background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); color: #ff8a80; padding: 15px; border-radius: 8px; margin: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); white-space: pre-line; word-break: break-all;}
        footer { margin-top: 30px; color: rgba(255,255,255,0.5); text-align: center; padding: 20px; font-size: 0.8rem; }
        .debug-box { background: #111; color: #0f0; padding: 10px; margin: 10px; font-family: monospace; font-size: 0.7rem; border-radius: 5px; max-height: 200px; overflow: auto; display: none; text-align: left; }
    </style>
</head>
<body>

<header>
    <div class="app-name">üèÉ Ë¶ÅÂãï‰∏ÄÂãïÂóé?</div>
    <div class="header-actions">
        <button class="btn-reload" onclick="window.location.reload()">‚Üª ÈáçÊï¥</button>
    </div>
</header>

<div class="container">
    <div id="loading" class="loading">
        Ê≠£Âú®ÂàÜÊûêÂ§©Ê∞£Êï∏Êìö...<br>
        <small style="opacity:0.7">CWA F-D0047-061/069</small>
    </div>
    <div id="error-display" class="error-msg" style="display:none;"></div>
    <div id="debug-info" class="debug-box"></div>

    <!-- Row 1: Êñ∞Â∫óÂçÄ (Top - Green Header) -->
    <div id="card-xindian" class="location-row" style="display:none;">
        <div class="loc-header">
            <div class="loc-title">Êñ∞Â∫óÂçÄ</div>
            <div class="loc-sub">Â§ÆÂåó/ÂçÅÂõõÂºµ</div>
        </div>
        <div class="loc-content">
            <div class="loc-main-data">
                <div class="update-tag" id="update-time-xindian">--:--</div>
                
                <div class="info-top">
                    <div class="weather-big">
                        <div class="weather-temp" id="curr-temp-xindian">--¬∞</div>
                        <div class="weather-desc">
                            <span id="curr-desc-xindian">--</span>
                            <div class="pop-label">ÈôçÈõ®Ê©üÁéá <span class="pop-val" id="curr-pop-xindian">--</span>%</div>
                        </div>
                    </div>
                    
                    <div class="rec-box">
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-u-xindian">--</span>
                            <span class="rec-text" id="text-u-xindian">--</span>
                        </div>
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-c-xindian">--</span>
                            <span class="rec-text" id="text-c-xindian">--</span>
                        </div>
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-s-xindian">--</span>
                            <span class="rec-text" id="text-s-xindian">--</span>
                        </div>
                    </div>
                </div>

                <div class="timeline-container">
                    <div class="timeline-header">
                        <span>Êú™‰æÜ 24 Â∞èÊôÇË∂®Âã¢</span>
                        <span style="opacity:0.6;">‚Üê ÊªëÂãï ‚Üí</span>
                    </div>
                    <div class="traffic-lights" id="lights-xindian"></div>
                </div>
            </div>

            <div class="more-info-bar" onclick="toggleDetails('table-xindian', this)">
                Ë©≥Á¥∞Êï∏Êìö <span>‚ñº</span>
            </div>
            <table id="table-xindian" class="forecast-table">
                <thead><tr><th>ÊôÇÈñì</th><th>È´îÊÑü</th><th>Â§©Ê∞£</th><th>ÈôçÈõ®</th></tr></thead>
                <tbody id="tbody-xindian"></tbody>
            </table>
        </div>
    </div>

    <!-- Row 2: ‰ø°Áæ©ÂçÄ (Bottom - Blue Header) -->
    <div id="card-xinyi" class="location-row" style="display:none;">
        <div class="loc-header">
            <div class="loc-title">‰ø°Áæ©ÂçÄ</div>
            <div class="loc-sub">ÂÖ≠ÂºµÁäÅ</div>
        </div>
        <div class="loc-content">
            <div class="loc-main-data">
                <div class="update-tag" id="update-time-xinyi">--:--</div>
                
                <div class="info-top">
                    <div class="weather-big">
                        <div class="weather-temp" id="curr-temp-xinyi">--¬∞</div>
                        <div class="weather-desc">
                            <span id="curr-desc-xinyi">--</span>
                            <div class="pop-label">ÈôçÈõ®Ê©üÁéá <span class="pop-val" id="curr-pop-xinyi">--</span>%</div>
                        </div>
                    </div>
                    
                    <!-- Recommendations (Horizontal) -->
                    <div class="rec-box">
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-u-xinyi">--</span>
                            <span class="rec-text" id="text-u-xinyi">--</span>
                        </div>
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-c-xinyi">--</span>
                            <span class="rec-text" id="text-c-xinyi">--</span>
                        </div>
                        <div class="rec-item">
                            <span class="rec-emoji" id="icon-s-xinyi">--</span>
                            <span class="rec-text" id="text-s-xinyi">--</span>
                        </div>
                    </div>
                </div>

                <div class="timeline-container">
                    <div class="timeline-header">
                        <span>Êú™‰æÜ 24 Â∞èÊôÇË∂®Âã¢</span>
                        <span style="opacity:0.6;">‚Üê ÊªëÂãï ‚Üí</span>
                    </div>
                    <div class="traffic-lights" id="lights-xinyi"></div>
                </div>
            </div>

            <!-- More Bar -->
            <div class="more-info-bar" onclick="toggleDetails('table-xinyi', this)">
                Ë©≥Á¥∞Êï∏Êìö <span>‚ñº</span>
            </div>
            <table id="table-xinyi" class="forecast-table">
                <thead><tr><th>ÊôÇÈñì</th><th>È´îÊÑü</th><th>Â§©Ê∞£</th><th>ÈôçÈõ®</th></tr></thead>
                <tbody id="tbody-xinyi"></tbody>
            </table>
        </div>
    </div>

</div>

<footer>
    <div>Data Source: CWA Open Data</div>
    <div class="build-info">Build# 2025120520 (ApparentTemp)</div>
    <div class="release-notes" style="margin-top:10px; font-size:0.75rem; opacity:0.6;">
        <strong>Release Notes v1.0.35:</strong>
        <br>- Feature: È°ØÁ§∫Ê∫´Â∫¶ÂÖ®Èù¢ÊîπÁÇ∫„ÄåÈ´îÊÑüÊ∫´Â∫¶ (AT)„ÄçÔºåÊõ¥Á¨¶ÂêàÈÅãÂãïÂèÉËÄÉÈúÄÊ±Ç„ÄÇ
        <br>- UI: Ê®ôÈ°åÊ¨ÑÈ°èËâ≤ÂçÄÂàÜÔºöÊñ∞Â∫ó(Á∂†) / ‰ø°Áæ©(Ëóç)„ÄÇ
    </div>
</footer>

<script>
    const CONFIG = {
        loc1: { dataId: "F-D0047-069", district: "Êñ∞Â∫óÂçÄ", uiId: "xindian" },
        loc2: { dataId: "F-D0047-061", district: "‰ø°Áæ©ÂçÄ", uiId: "xinyi" }
    };
    const ENC_KEY = "Q1dBLTcwNENBMjRGLTM5OEMtNEYzRi1BRDU3LUI2OUYzMkY5NkU0Mg==";
    const API_KEY = atob(ENC_KEY);

    document.addEventListener("DOMContentLoaded", () => {
        initWeather();
    });

    async function initWeather() {
        try {
            document.getElementById("error-display").style.display = "none";
            await Promise.all([ fetchAndRender(CONFIG.loc1), fetchAndRender(CONFIG.loc2) ]);
            document.getElementById("loading").style.display = "none";
            document.getElementById("card-xinyi").style.display = "flex";
            document.getElementById("card-xindian").style.display = "flex";
        } catch (error) {
            console.error(error);
            document.getElementById("loading").style.display = "none";
            const err = document.getElementById("error-display");
            err.style.display = "block";
            err.innerText = "Error: " + error.message;
        }
    }

    async function fetchAndRender(loc) {
        const ts = new Date().getTime();
        const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/${loc.dataId}?Authorization=${API_KEY}&locationName=${encodeURIComponent(loc.district)}&_t=${ts}`;
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); 
        
        try {
            const res = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);
            const data = await res.json();
            
            if (data.success === "false") throw new Error(data.message.text);
            
            const records = data.records || data.Records;
            if (!records) throw new Error("API Records missing");
            
            const locWrap = records.locations || records.Locations;
            if (!locWrap || locWrap.length === 0) throw new Error("API Locations missing");
            
            const locList = locWrap[0].location || locWrap[0].Location;
            if (!locList || locList.length === 0) throw new Error(`Êâæ‰∏çÂà∞Âú∞ÂçÄË≥áÊñô: ${loc.district}`);
            
            const elements = locList[0].weatherElement || locList[0].WeatherElement;
            const processed = processData(elements, loc.uiId);
            renderUI(loc.uiId, processed);
        } catch (e) {
            clearTimeout(timeoutId);
            throw e;
        }
    }

    function getValue(obj) {
        if (!obj) return null;
        if (obj["value"] !== undefined) return obj["value"];
        if (obj["Value"] !== undefined) return obj["Value"];
        if (obj["ProbabilityOfPrecipitation"] !== undefined) return obj["ProbabilityOfPrecipitation"];
        if (obj["Temperature"] !== undefined) return obj["Temperature"];
        const values = Object.values(obj);
        if (values.length > 0) return values[0];
        return null;
    }

    function getProp(obj, propName) {
        if (!obj) return null;
        if (obj[propName] !== undefined) return obj[propName];
        if (obj[propName.toLowerCase()] !== undefined) return obj[propName.toLowerCase()];
        const cap = propName.charAt(0).toUpperCase() + propName.slice(1);
        if (obj[cap] !== undefined) return obj[cap];
        return null;
    }

    function getEl(elements, possibleNames) {
        return elements.find(e => {
            const name = e.elementName || e.ElementName;
            return possibleNames.includes(name);
        });
    }

    function processData(elements, uiId) {
        // Change priority: AT (Apparent Temp) > T (Temp)
        const rawT = getEl(elements, ["AT", "È´îÊÑüÊ∫´Â∫¶"]) || getEl(elements, ["T", "Ê∫´Â∫¶"]);
        if(!rawT) return [];

        const T_list = getProp(rawT, "time");
        const rawWx = getEl(elements, ["Wx", "Â§©Ê∞£ÁèæË±°"]);
        const Wx_list = rawWx ? getProp(rawWx, "time") : [];
        const rawPoP = getEl(elements, ["PoP3h", "3Â∞èÊôÇÈôçÈõ®Ê©üÁéá", "PoP12h", "PoP6h"]);
        const PoP_list = rawPoP ? getProp(rawPoP, "time") : [];
        const rawRain = getEl(elements, ["Rain", "Rainfall", "Èõ®Èáè"]); 
        const Rain_list = rawRain ? getProp(rawRain, "time") : [];

        let result = [];
        T_list.forEach(t => {
            let startStr = t.startTime || t.StartTime || t.dataTime || t.DataTime;
            let endStr = t.endTime || t.EndTime;
            const start = new Date(startStr);
            let end;
            if (endStr) end = new Date(endStr);
            else end = new Date(start.getTime() + 3 * 60 * 60 * 1000);

            const tVals = getProp(t, "elementValue");
            if(!tVals || tVals.length === 0) return;
            const tValStr = getValue(tVals[0]);
            const tVal = parseInt(tValStr);
            
            const wxItem = Wx_list.find(w => {
                const wS = w.startTime || w.StartTime || w.dataTime || w.DataTime;
                return new Date(wS).getTime() === start.getTime();
            });
            let wxDesc = "-", wxCode = 0;
            if(wxItem) {
                const wVals = getProp(wxItem, "elementValue");
                if(wVals && wVals.length > 0) wxDesc = getValue(wVals[0]);
                if(wVals && wVals.length > 1) wxCode = parseInt(getValue(wVals[1]));
            }

            // PoP
            let popVal = "0";
            let popItem = PoP_list.find(p => {
                const pS = p.startTime || p.StartTime || p.dataTime || p.DataTime;
                return new Date(pS).getTime() === start.getTime();
            });
            
            if (!popItem) {
                popItem = PoP_list.find(p => {
                    const ps = new Date(p.startTime || p.StartTime);
                    const pe = new Date(p.endTime || p.EndTime);
                    return (start < pe && end > ps);
                });
            }

            if(popItem) {
                const pVals = getProp(popItem, "elementValue");
                if(pVals && pVals.length > 0) popVal = getValue(pVals[0]);
            }

            let rainVal = null;
            if (Rain_list.length > 0) {
                const rItem = Rain_list.find(r => {
                    const rS = r.startTime || r.StartTime || r.dataTime || r.DataTime;
                    return new Date(rS).getTime() === start.getTime();
                });
                if (rItem) {
                    const rVals = getProp(rItem, "elementValue");
                    if(rVals && rVals.length > 0) rainVal = getValue(rVals[0]);
                }
            }

            result.push({
                start, end, temp: tVal, wx: wxDesc, code: wxCode, pop: popVal, rain: rainVal
            });
        });
        return result.sort((a,b) => a.start - b.start);
    }

    function renderUI(uiId, data) {
        if(!data || data.length === 0) return;

        const now = new Date();
        let future = data.filter(d => d.end > now);
        if (future.length === 0 && data.length > 0) future = data.slice(-3);
        if (future.length === 0) return;

        let list = [];
        let cursor = null;
        future.forEach(item => {
            if (!cursor || item.start >= cursor) {
                list.push(item);
                cursor = item.end;
            }
        });

        const cur = list[0];
        
        const displayTemp = isNaN(cur.temp) ? "--" : cur.temp;
        const displayPop = (cur.pop === null || cur.pop === " " || isNaN(parseInt(cur.pop))) ? "0" : cur.pop;

        document.getElementById(`curr-temp-${uiId}`).innerHTML = `${displayTemp}¬∞<span class="temp-label-small">È´îÊÑü</span>`;
        document.getElementById(`curr-desc-${uiId}`).innerText = cur.wx;
        document.getElementById(`curr-pop-${uiId}`).innerText = displayPop;
        
        const d = new Date();
        document.getElementById(`update-time-${uiId}`).innerText = `Êõ¥Êñ∞: ${pad(d.getHours())}:${pad(d.getMinutes())}`;

        const rec = getRec(cur.temp, parseInt(displayPop), cur.code);
        document.getElementById(`icon-u-${uiId}`).innerText = rec.u.i;
        document.getElementById(`text-u-${uiId}`).innerText = rec.u.t;
        
        document.getElementById(`icon-c-${uiId}`).innerText = rec.c.i;
        document.getElementById(`text-c-${uiId}`).innerText = rec.c.t;
        
        document.getElementById(`icon-s-${uiId}`).innerText = rec.s.i;
        document.getElementById(`text-s-${uiId}`).innerText = rec.s.t;

        // Lights
        const lights = document.getElementById(`lights-${uiId}`);
        lights.innerHTML = "";
        list.slice(0, 8).forEach(slot => {
            const st = getStatus(slot);
            const div = document.createElement("div");
            div.className = "light-block";
            div.style.backgroundColor = st.color;
            
            let pVal = (slot.pop === null || slot.pop === " ") ? "0" : slot.pop;
            let tVal = isNaN(slot.temp) ? "--" : slot.temp;

            let rainTxt = `Èõ® ${pVal}%`;
            if (slot.rain && slot.rain !== "0" && slot.rain !== "0.0") rainTxt += `<br><span class="rain-mm">Èáè${slot.rain}mm</span>`;

            div.innerHTML = `
                <div class="time-label">${formatH(slot.start.getHours())}~${formatH(slot.end.getHours())}</div>
                <div class="status-emoji">${st.emoji}</div>
                <div class="status-text">${st.text}</div>
                <div class="temp-sub">
                    <div>${tVal}¬∞</div>
                    <div class="rain-sub">${rainTxt}</div>
                </div>
            `;
            lights.appendChild(div);
        });

        // Table
        const tb = document.getElementById(`tbody-${uiId}`);
        tb.innerHTML = "";
        list.slice(0, 16).forEach(d => {
            let pVal = (d.pop === null || d.pop === " ") ? "0" : d.pop;
            let tVal = isNaN(d.temp) ? "--" : d.temp;
            tb.innerHTML += `<tr>
                <td>${d.start.getMonth()+1}/${d.start.getDate()} <br>${formatH(d.start.getHours())}~${formatH(d.end.getHours())}</td>
                <td>${tVal}¬∞</td><td>${d.wx}</td><td>${pVal}%</td>
            </tr>`;
        });
    }

    function getStatus(d) {
        let s = 4; 
        const pop = parseInt(d.pop) || 0;
        
        if (pop >= 60) s = 1; 
        else if (pop >= 30) s = 2; 
        else if (pop >= 20) s = 3; 

        if (d.code >= 15 && d.code <= 22) s = 1; 
        
        if (d.temp > 35 || d.temp < 10) s = Math.min(s, 2);
        else if (d.temp > 31 || d.temp < 14) s = Math.min(s, 3);
        else if (d.temp >= 19 && d.temp <= 27 && pop < 15) s = 5; 

        const map = {
            1: { color: "#ef9a9a", text: "Sleep", emoji: "üò¥" },
            2: { color: "#ffcc80", text: "Light Rain", emoji: "üåßÔ∏è" },
            3: { color: "#fff59d", text: "Nice", emoji: "üòä" },
            4: { color: "#81d4fa", text: "Comfy", emoji: "ü§©" },
            5: { color: "#a5d6a7", text: "Great!", emoji: "üéâ" }
        };
        return map[s] || map[3];
    }

    function getRec(t, p, c) {
        let u = { i: "üåÇ", t: "‰∏çÁî®Â∏∂ÂÇò" };
        let cl = { i: "üëï", t: "ËàíÈÅ©Á©øËëó" };
        let sp = { i: "üèÉ", t: "ÈÅ©ÂêàÊà∂Â§ñ" };

        if (p >= 50 || (c >= 11 && c <= 22)) u = { i: "‚òî", t: "ÂãôÂøÖÂ∏∂ÂÇò" };
        else if (p >= 20) u = { i: "‚òÇÔ∏è", t: "Âª∫Ë≠∞ÊäòÂÇò" };

        if (t < 15) cl = { i: "üß•", t: "Ê¥ãËî•‰øùÊöñ" };
        else if (t < 20) cl = { i: "üëî", t: "Èï∑Ë¢ñÂ§ñÂ•ó" };
        else if (t > 28) cl = { i: "üéΩ", t: "Áü≠Ë¢ñÈÄèÊ∞£" };
        else if (t > 32) cl = { i: "üß¢", t: "Ê≥®ÊÑèÈò≤Êõ¨" };

        if (p >= 40) sp = { i: "üè†", t: "ÂÆ§ÂÖßÈÅãÂãï" }; 
        else if (p >= 20) sp = { i: "ü¶∂", t: "Â∞èÂøÉÊøïÊªë" };
        else if (t > 33) sp = { i: "üíß", t: "Ê≥®ÊÑèË£úÊ∞¥" };
        else if (t < 12) sp = { i: "üî•", t: "Ê≥®ÊÑèÊöñË∫´" };

        return { u, c: cl, s: sp };
    }

    function pad(n) { return n.toString().padStart(2,'0'); }
    function formatH(h) { return pad(h); }
    function toggleDetails(id, btn) { 
        document.getElementById(id).classList.toggle("show"); 
        btn.classList.toggle("active");
    }
</script>

</body>
</html>